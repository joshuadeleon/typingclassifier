@{
    ViewBag.Title = "Typing Classifier";
}
@section scripts
{
  <script type="text/javascript">
    'use strict'

    $(function() {
      var start
        , trapper
        , currentEvent
        , payload = {}
        , events = []
        , capturing = false;

      var now = getTimer();

      function resetTrapper() {
        if(trapper) { window.clearTimeout(trapper); }
        trapper = setTimeout(function() {
          capturing = false;
          console.log('stopped capturing');
        }, 1005);
      }

      $('#score-btn').click(function() {
        if(rootOutCheaters()) {
          alert('Thanks for cheating. You are our newest inductee into the hall of shame.');
          return;
        }
        if(!isValid()) {
          return;
        }
        payload.handle = $('#handle').val();
        payload.email = $('#email').val();
        payload.events = events.slice();
        $.ajax({
          url: 'http://localhost:51712/sink',
          type: 'POST',
          contentType: 'application/json; charset=utf-8',
          data: JSON.stringify(payload),
          dataType: 'json',
          success: function() { events = []; clearText(); },
          error: function(e) { console.log(e); },
          processData: false
        });
      });

      function loop() {
        setTimeout(function() {
          if(isComplete()) {
            $('#score-btn').prop('disabled', false);
          }
          loop();
        }, 200);
      }

      document.addEventListener('keydown', function(event) {
        resetTrapper();
        if(!capturing) {
          console.log('capturing...');
          capturing = true;
          start = now();
        }
        if(event.repeat) {
          return;
        }
        var t = now();
        currentEvent = {
          e: event.key,
          t: t
        };
      });

      document.addEventListener('keyup', function(event) {
        var up = now();
        currentEvent.d = up - currentEvent.t;
        events.push(currentEvent);
        console.log(currentEvent);
      });

      loop();
    });

    function getTimer() {
      if(window.performance.now) {
        return function() { return window.performance.now(); };
      } else if(window.performance.webkitNow) {
        return function() { return window.performance.webkitNow(); }
      } else {
        return function() { return new Date().getTime(); }
      }
    }

    function rootOutCheaters() {
      var cs = $('#sentinel').text().length;
      var isCheater = isComplete() && events.length < cs;
      if(isCheater) {
        console.log('You are our newest inductee into the hall of shame.');
      }
      return isCheater;
    }

    function isValid() {
      var isValid = validateById('#handle') && validateById('#email');
      return isValid;
    }

    function validateById(id) {
      if($(id).val().length == 0) {
        $(id).addClass('error');
        return false;
      }
      return true;
    }

    function isComplete() {
      var text = $('#sentinel').text().trim();
      var input = $('#user-input').val().trim();
      return text === input;
    }

    function clearText() {
      $('#user-input').val('');
    }

  </script>
}
<main class="container body-content">
    <section>
        <h4>Please enter a handle and a valid email address:</h4>
    <label>Handle</label>
    <input id="#handle" type="text" value="" />
    <label>Email</label>
    <input id="#email" type="email" />
    </section>
  <section>
    <h4>Please submit the following input into our Freudian Psychoanalyzer:</h4>
    <p oncopy="return false" id="sentinel">
      For a long time I used to go to bed early. Sometimes, when I had put out my candle, my eyes would close so quickly that I had not even time to say “I’m going to sleep.”
    </p>
    <textarea id="user-input" class="input"></textarea>
    <button class="btn btn-primary" id="score-btn" disabled="true">Go to Results</button>
  </section>
</main>